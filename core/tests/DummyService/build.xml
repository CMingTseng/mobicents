<?xml version="1.0" encoding="utf-8"?>
<project default="all" name="dummySleeContainerTest">

	<property description="The directory where mobicents source is checked out" name="mobicents.home" value="../.." />
	<import file="${mobicents.home}/xml/ant/mobicents-ant-common-properties.xml" />
	
	<property name="project.home" value="." />
	
	<property description="Controls the jboss conrfiguration. Value is typically 'all'" name="node" value="all" />
	<property name="DU.deploy.dir" value="${jboss.home}/server/${node}/deploy-mobicents" />
	<property name="deploy.dir" value="${jboss.home}/server/${node}/deploy" />
	<property name="sipra" value="../slee-sip-ra/" />



	<!-- DEPLOY & UNDEPLOY STUFF -->
	<property name="jnpHost" value="127.0.0.1" />

	<!-- SLEE MANAGEMENT -->
	
	<target name="init" depends="init-common">
		<path id="slee">
			<pathelement location="${mobicents.home}/lib/slee_1_1.jar" />
			<pathelement location="${mobicents.home}/tests/lib/container/dummy-ra-DU.jar" />
			<pathelement location="${mobicents.home}/tests/lib/container/dummy-ratype-DU.jar" />
			<pathelement location="${mobicents.home}/tests/lib/container/dummy-event.jar" />

			<pathelement location="${mobicents.home}/lib/log4j.jar" />
		</path>
		<path id="deployer.class.path">
			<pathelement location="${mobicents.home}/lib/slee_1_1.jar" />
			<pathelement location="${jboss.home}/client/client.jar" />
			<pathelement location="${jboss.home}/client/jbossall-client.jar" />
			<pathelement location="${jboss.home}/client/getopt.jar" />
			<pathelement location="${jboss.home}/lib/log4j.jar" />
			<pathelement location="${jboss.home}/lib/jboss-jmx.jar" />
			<pathelement location="${jboss.home}/lib/xml-apis.jar" />
			<pathelement location="${jboss.home}/lib/xercesImpl.jar" />
			<pathelement location="${jboss.home}/server/all/deploy/mobicents.sar" />
		</path>
		<taskdef classname="com.opencloud.ant.SbbJar" classpath="${mobicents.home}/lib/slee-tasks.jar" name="sbbjar" />
		<taskdef classname="com.opencloud.ant.EventJar" classpath="${mobicents.home}/lib/slee-tasks.jar" name="eventjar" />
		<taskdef classname="com.opencloud.ant.ProfileSpecJar" classpath="${mobicents.home}/lib/slee-tasks.jar" name="profilespecjar" />
		<taskdef classname="com.opencloud.ant.DeployableJar" classpath="${mobicents.home}/lib/slee-tasks.jar" name="deployablejar" />
		<taskdef classname="com.opencloud.ant.ResourceAdaptorTypeJar" classpath="${mobicents.home}/lib/slee-tasks.jar" name="resourceadaptortypejar" />
		<taskdef classname="com.opencloud.ant.ResourceAdaptorJar" classpath="${mobicents.home}/lib/slee-tasks.jar" name="resourceadaptorjar" />
	</target>
	<target depends="init,build-DummySbbService-DU" name="all">

	</target>
	<target name="clean">
		<ant target="clean-Dummy-sbb" />
		<ant target="clean-DummySbbService-DU" />
		<ant target="clean-SecondDummy-sbb" />
		<delete dir="classes" />
	</target>
	<target depends="init" name="build-Dummy-sbb">
		<mkdir dir="classes/Dummy-sbb" />
		<mkdir dir="jars/" />
		<javac destdir="classes/Dummy-sbb" srcdir="src" includes="org/mobicents/slee/resource/ra/tests/xmpp_sip/DummySbb.java">
			<classpath>
				<path refid="slee" />
			</classpath>

		</javac>
		<!-- NOT SURE WHY BUT WHEN THIS IS CALLED FROM tests/build.xml IT CANT FIND sbb-jar.xml!!! -->
		<!--
		<sbbjar classpath="classes/Dummy-sbb" destfile="jars/Dummy-sbb.jar" sbbjarxml="src/org/mobicents/slee/resource/ra/tests/xmpp_sip/Dummy-sbb-jar.xml" />
		-->
		<copy file="src/org/mobicents/slee/resource/ra/tests/xmpp_sip/Dummy-sbb-jar.xml" tofile="classes/Dummy-sbb/sbb-jar.xml" />
		<jar jarfile="jars/Dummy-sbb.jar">
			<metainf dir="classes/Dummy-sbb/" includes="sbb-jar.xml" />
			<fileset dir="classes/Dummy-sbb" includes="**/*.class" />
		</jar>

	</target>
	<target name="clean-Dummy-sbb">
		<delete file="jars/Dummy-sbb.jar" />
		<delete dir="classes/Dummy-sbb" />
	</target>
	<target depends="build-Dummy-sbb,build-SecondDummy-sbb" name="build-DummySbbService-DU">
		<mkdir dir="classes/DummySbbService-DU" />
		<copy file="src/org/mobicents/slee/resource/ra/tests/xmpp_sip/DummySbbService-deployable-unit.xml" tofile="classes/DummySbbService-DU/deployable-unit.xml" />
		<jar jarfile="jars/DummySbbService-DU.jar">
			<metainf dir="classes/DummySbbService-DU" includes="deployable-unit.xml" />
			<fileset dir="" includes="jars/Dummy-sbb.jar" />
			<fileset dir="" includes="jars/SecondDummy-sbb.jar" />
			<fileset dir="./src/org/mobicents/slee/resource/ra/tests/xmpp_sip/" includes="DummySbb-service.xml" />
		</jar>
	</target>
	<target name="clean-DummySbbService-DU">
		<delete file="jars/DummySbbService-DU.jar" />
		<delete dir="classes/DummySbbService-DU" />
	</target>
	<target depends="init,build-DummySbbService-DU" description="Copies all components to the deployment directories. The server will consequently deploy or redeploy them." name="auto-deploy">
		<copy file="jars/DummySbbService-DU.jar" todir="${DU.deploy.dir}" />
		<!-- the bsh file name starts with a 'z' to ensure that it is executed after the RA scripts-->
		<copy file="bin/zDummyCleeContainerTest-deploy.bsh" todir="${DU.deploy.dir}/scripts" />
	</target>
	<target description="Deletes all components placed in the server directories." name="auto-deploy-clean">
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${DU.deploy.dir}">
				<include name="DummySbbService-DU.jar" />
				<include name="scripts/zDummyCleeContainerTest-deploy.bsh" />
			</fileset>
		</delete>
	</target>
	<target depends="init" name="build-SecondDummy-sbb">
		<mkdir dir="classes/SecondDummy-sbb" />
		<mkdir dir="jars/" />
		<javac destdir="classes/SecondDummy-sbb" srcdir="src" includes="org/mobicents/slee/resource/ra/tests/xmpp_sip/SecondDummySbb.java">
			<classpath>
				<path refid="slee" />
			</classpath>

		</javac>
		<!--
		<sbbjar classpath="classes/SecondDummy-sbb" destfile="jars/SecondDummy-sbb.jar" sbbjarxml="src/org/mobicents/slee/resource/ra/tests/xmpp_sip/SecondDummy-sbb-jar.xml" />
    -->

		<copy file="src/org/mobicents/slee/resource/ra/tests/xmpp_sip/SecondDummy-sbb-jar.xml" tofile="classes/SecondDummy-sbb/sbb-jar.xml" />
		<jar jarfile="jars/SecondDummy-sbb.jar">
			<metainf dir="classes/SecondDummy-sbb/" includes="sbb-jar.xml" />
			<fileset dir="classes/SecondDummy-sbb" includes="**/*.class" />
		</jar>

	</target>
	<target name="clean-SecondDummy-sbb">
		<delete file="jars/SecondDummy-sbb.jar" />
		<delete dir="classes/SecondDummy-sbb" />
	</target>

	<target name="deploy" depends="all,init,d1,activate" description="Deploys the SIP Proxy Service">


	</target>

	<target name="d1" depends="init">
		<path id="proxyservice">
			<pathelement location="jars/DummySbbService-DU.jar" />
		</path>
		<pathconvert targetos="unix" property="proxyservice" refid="proxyservice" />
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<install url="${file_url}${proxyservice}" />
		</slee-management>
		<echo>==== DEPLOYED !!! =================</echo>
	</target>

	<target name="activate" depends="init">
		<!-- Activate the proxy service -->
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<activateservice serviceid="DummySbbService#mobicents#0.1" />
		</slee-management>
		<echo>=========== ACTIVATED==============</echo>

	</target>

	<target name="undeploy" depends="init" description="unDeploys the SIP Proxy Service">
		<path id="proxyservice">
			<pathelement location="jars/DummySbbService-DU.jar" />
		</path>
		<pathconvert targetos="unix" property="proxyservice" refid="proxyservice" />

		<!-- Activate the proxy service -->
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<deactivateservice serviceid="DummySbbService#mobicentsT#0.1" />
		</slee-management>
		<echo> proxy service deactivated </echo>

		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<uninstall url="${file_url}${proxyservice}" />
		</slee-management>
		<echo>Proxy Service deployed</echo>
	</target>


	<target name="deploy-auto" depends="init">
		<copy file="jars/DummySbbService-DU.jar" todir="${DU.deploy.dir}" />
		<copy file="./bin/zDummyCleeContainerTest-deploy.bsh" todir="${DU.deploy.dir}/scripts" />
	</target>
	<target name="clean-auto" depends="init">
		<delete file="${DU.deploy.dir}/DummySbbService-DU.jar" />
		<delete file="${DU.deploy.dir}/scripts/zDummyCleeContainerTest-deploy.bsh" />
	</target>
</project>
