<?xml version='1.0'?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<section
	id="section-Mobicents_Presence_Server"
	xreflabel="Presence Server">
	<title>Mobicents Presence Server</title>
	<section
		id="section-Introduction_to_the_Mobicents_Presence_Server">
		<title>Introduction to the Mobicents Presence Server</title>
		<para>Mobicents Presence Server is a free and open source implementation of a SIP Presence Server, as defined by the Internet Engineering Task Force (IETF), the Open Mobile Alliance (OMA), the 3rd Generation Partnership Project (3GPP) and the European Telecommunications Standards Institute (ETSI).</para>
		<para>The Presence Server is an entity that accepts, stores and distributes SIP Presence Information.</para>
		<formalpara>
			<title>Functional Architecture of the Mobicents Presence Server</title>
			<para></para>
		</formalpara>
		<figure
			id="figure-orig-PS_Functional_Architecture.jpg">
			<title>The Mobicents Presence Server</title>
			<mediaobject
				id="mediaobj-orig-PS_Functional_Architecture.jpg">
				<imageobject>
					<imagedata
						align="center"
						fileref="images/orig-PS Functional Architecture.jpg"
						format="JPG" />
				</imageobject>
				<caption>
					<para>Functional Diagram of the Mobicents Presence Server</para>
				</caption>
			</mediaobject>
		</figure>
		<para>The Presence Server comprises the following functional elements:</para>
		<variablelist
			id="varlist-The_Functional_Elements_Which_Compose_the_Presence_Server">
			<title>The Functional Elements Which Compose the Presence Server</title>
			<varlistentry>
				<term>Presence Publication Control</term>
				<listitem>
					<para>This functional element manages the publication of presence events, which includes not only the handling of new publications, but also the refreshing, modification or removal of, already-published information.</para>
					<para>Because the presence resource, which is also called a <quote>presentity</quote>, can have multiple publications simultaneously, such as some state published by a user agent or device, and some location data published by a Presence Network Agent (on behalf of the presentity), this element is also responsible for composing all of the different publications for the same resource.</para>
					<para>In some presence networks, it may be of interest to allow resources to have a static presence state, which is stored in the XDM Server. In cases like these, Presence Publication Control may need to interface with the XDM Server to retrieve and subscribe to (learn about changes to) that information, and use it when composing the final presence information document.</para>
				</listitem>
			</varlistentry>
			<varlistentry>
				<term>Presence Subscription Control</term>
				<listitem>
					<para>This functional element handles subscriptions to presence events or to the list of subscribers (watchers), for any specific resource. It is, of course, responsible for emitting notifications related to those subscriptions.</para>
					<para>Presence authorization rules, which define if a subscription is allowed or rejected and, if allowed, define which transformations to the original presence events are needed, are stored on the XDM Server by the user. Thus, Presence Subscription Control needs to retrieve and subscribe to (learn about changes to) that information.</para>
				</listitem>
			</varlistentry>
			<varlistentry>
				<term>XDM Client Control</term>
				<listitem>
					<para>This last element is responsible for interfacing with the XDM Server that manages the user's XML documents, and is related to the main functions of the presence server. It's capable not only of retrieving a document (or part of one), but also of subscribing to either updates of a single, specific document, or to a full collection of documents of a specific type or application.</para>
				</listitem>
			</varlistentry>
		</variablelist>
		<formalpara>
			<title>Implementation Architecture of the Mobicents Presence Server</title>
			<para></para>
		</formalpara>
		<figure
			id="figure-orig-PS_Implementation.jpg">
			<title>Implementation Architecture of the Mobicents Presence Server</title>
			<mediaobject
				id="mediaobj-orig-PS_Implementation.jpg">
				<imageobject>
					<imagedata
						align="center"
						width="700"
						fileref="images/orig-PS Implementation.jpg"
						format="JPG" />
				</imageobject>
				<caption>
					<para>The Mobicents Presence Server</para>
				</caption>
			</mediaobject>
		</figure>
		<para>The implementation of the Mobicents Presence Server comprises the following functional elements:</para>
		<variablelist
			id="varlist-The_Two_Services_Which_Compose_the_Presence_Server">
			<title>The Two Services Which Compose the Presence Server</title>
			<varlistentry>
				<term>Presence Publication Control Service</term>
				<listitem>
					<para>This JAIN SLEE service includes the root Service Building Block (SBB), <literal>PresencePublicationControlSbb</literal>, which is the implementation of the abstract SIP event <literal>PublicationControlSbb</literal>. It handles publications on the "presence" event package.</para>
					<para>The <literal>PresencePublicationControlSbb</literal> provides the following capabilities:</para>
					<itemizedlist>
						<listitem>
							<para>It provides the logic to authorize a publication; however, it only authorizes <literal>PUBLISH</literal> requests when the request URI matches the PIDF document <quote>entity</quote> attribute.</para>
						</listitem>
						<listitem>
							<para>It provides JAXB unmarshellers to validate and parse the PIDF document for the abstract <literal>PublicationControlSbb</literal>.</para>
						</listitem>
						<listitem>
							<para>It demands that notifying subscribers occur through a child relation to the root SBB of the Presence Subscription Control Service.</para>
						</listitem>
						<listitem>
							<para>Finally, it also provides an <literal>SbbLocalObject</literal> interface that can be used, in JAIN SLEE child relations, to obtain the composed presence information for a specific resource.</para>
						</listitem>
					</itemizedlist>
				</listitem>
			</varlistentry>
			<varlistentry>
				<term>Presence Subscription Control Service.</term>
				<listitem>
					<para>This JAIN SLEE service includes the root SBB <literal>PresenceSubscriptionControlSbb</literal>, which is the implementation of the abstract SIP Event <literal>SubscriptionControlSbb</literal>. It handles subscriptions on the "presence" event package.</para>
					<para>The standout SBB logic item is the usage of presence-rules documents, obtained through the XDM Client SBB child relation, in order to authorize subscriptions and transform the content notified (TBD: feature not used yet). It also defines a child relation to the root SBB of <literal>PresencePublicationService</literal> to retrieve the composed PIDF document for the subscription's notifier.</para>
					<para>The SBB also provides an <literal>SbbLocalObject</literal> interface that can be used, in JAIN SLEE child relations, to make the presence event known to the subscribers of a specific resource.</para>
				</listitem>
			</varlistentry>
		</variablelist>
		<para>The implementation architecture of the Presence Server also contains client-side components:</para>
		<variablelist
			id="varlist-">
			<title></title>
			<varlistentry>
				<term>Presence Client SBB (TBD: not yet available)</term>
				<listitem>
					<para>The <literal>PresenceClientSBB</literal> is the interface to a JAIN SLEE SBB intended to be used as a client for the Mobicents Presence Server (and other servers compliant with same standards), in JAIN SLEE child relations.</para>
					<para>Two implementations of this interface are provided: the <literal>InternalPresenceClientSBB</literal> that is used with applications running in the Mobicents Presence Server JAIN SLEE container, and the <literal>ExternalPresenceClientSBB</literal>, used with applications running in a different JAIN SLEE container than the Mobicents Presence Server.</para>
				</listitem>
			</varlistentry>
		</variablelist>
		<para>This documentation is originally from http://groups.google.com/group/mobicents-public/web/mobicents-sip-presence-server by Eduardo Martins, JBoss R&amp;D.
	TBD: Server setup and testing section, following this section or perhaps before.
	XCAP Aware User Agent: The PS server calculates pres-rules XCAP uris of users, by default, using a non standard way, but compatible with Counterpath Eyebeam. You can change to the standards recommended way in the hard coded field "clientUAIsEyebeam" of PresenceSubscriptionControlSbb (in ps-core/subscription-sbb/src/main/java/..). This is a temporary solution due to a feature, in current jain-sip stack, that removes invalid User-Agent headers (seems most UAs are failing here) of SIP REQUESTS. In the future this configuration will not be needed.

There is no configuration needed to deploy the server.
Requirements

The Mobicents Presence Server depends on Mobicents JAIN SLEE server and Mobicents SIP resource adaptor, ensure all are installed. 
Install/Uninstall

At the moment the Mobicents Presence Server can only be installed integrated with Mobicents XDM Server, that is, in the all-in-1 Presence Service architecture. This is due to lack of external XDM Client SBB component.

 

From source code repository, install doing mvn install on directory /trunk/servers/sip-presence/integrated, uninstall doing mvn clean on same directory.

Using a binary release, install doing ant deploy on directory servers/sip-presence/integrated, uninstall doing ant undeploy on same directory.

 

Note: This will also install Mobicents XDM server, ensure all it's requirements are met too. 
Testing 
A test framework for the server is not available ... yet. 
Resources:

    * How to manage the server
    * Integrating PS in your JAIN SLEE Apps: code snippets for Internal Presence Client SBB usage
    * Integrating PS in your JAIN SLEE Apps: code snippets for External Presence Client SBB usage
    * Mobicents Sip Event Publication and Subscription Control components 
    * Mobicents SIP Presence Service </para>
	</section>
</section>

