<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>8.5.5. API Methods and Usage</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
      <link rel="start" href="index.html" title="Mobicents"/>
      <link rel="up" href="section-MMS_Control_API.html" title="8.5. MMS Control API"/>
      <link rel="prev" href="section-MSC_API_Objects_Finite_State_Machines.html" title="8.5.4. MSC API Objects: Finite State Machines"/>
      <link rel="next" href="section-MMS_Event_Packages.html" title="8.6. MMS Event Packages"/>
   </head>
   <body>
      <p id="title">
         <a href="http://www.jboss.org" class="jbossOrg_href">
            <strong>
						        JBoss.org	
						</strong>
         </a>
         <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
            <strong>
						        Community Documentation	
						</strong>
         </a>
      </p>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="section-MSC_API_Objects_Finite_State_Machines.html">
               <strong>Prev</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="section-MMS_Event_Packages.html">
               <strong>Next</strong>
            </a>
         </li>
      </ul>
      <div class="section" lang="en-US">
         <div class="titlepage">
            <div>
               <div>
                  <h3 class="title">
                     <a id="section-API_Methods_and_Usage"/>8.5.5. API Methods and Usage</h3>
               </div>
            </div>
         </div>
         <p>So far we have specified the key objects as well as their FSMs. To understand operationally how these objects are used and the methods they offer, we refer the user to the UML sequence diagram examples. The following call flow depicts the simple announcement.</p>
         <div class="mediaobject" align="center">
            <a id="mediaobj-IVR-msc-api.jpg"/>
            <img src="images/IVR-msc-api.jpg" align="middle"/>
            <div class="caption">
               <p/>
            </div>
         </div>
         <p class="remark">
            <i>
               <span class="remark">TBD: Replace this orderedlist with a callout list once the graphic is remade.</span>
            </i>
         </p>
         <div class="orderedlist">
            <ol>
               <li>
                  <p>application receives underlying signaling message</p>
               </li>
               <li>
                  <p>application registers listeners</p>
               </li>
               <li>
                  <p>application registers listeners</p>
               </li>
               <li>
                  <p>application registers listeners</p>
               </li>
               <li>
                  <p>application creates MsSession object.</p>
               </li>
               <li>
                  <p>application creates MsConnection object using MsSession object.</p>
               </li>
               <li>
                  <p>application modify MsConnection passing SDP descriptor received on signaling channel.</p>
               </li>
               <li>
                  <p>MsConnection implementation sends request to the Media Server using one of the control protocol.</p>
               </li>
               <li>
                  <p>Server responds that connection on the Media server is created</p>
               </li>
               <li>
                  <p>Application receive ConnectionEvent.CONNECTION_CREATED</p>
               </li>
               <li>
                  <p>application obtains server's SDP and sends response to the UA. Media conversation started.</p>
               </li>
               <li>
                  <p>Application creates SignalGenerator and ask it to play announcement</p>
               </li>
               <li>
                  <p>Application creates SignalGenerator and ask it to play announcement</p>
               </li>
               <li>
                  <p>Application creates SignalGenerator and ask it to play announcement</p>
               </li>
               <li>
                  <p>Server report that announcement complete.</p>
               </li>
               <li>
                  <p>Server report that announcement complete.</p>
               </li>
            </ol>
         </div>
         <div class="example">
            <a id="example-Example_Code"/>
            <div class="example-contents">
               <a id="proglist-Example_Code"/>
               <pre class="programlisting">
package org.mobicents.mscontrol;

import org.mobicents.media.msc.common.MsLinkMode;
import org.mobicents.media.server.impl.common.events.EventID;
import org.mobicents.mscontrol.impl.MsProviderImpl;

/**
 * This is just a psuedocode to show how to use the MSC Api. This example uses
 * the Packet Relay Endpoint and Announcement Endpoint as follows
 *
 * UA &lt;----&gt; RTP Connection &lt;---- (one side) Packet Relay Endpoint (other side) &lt;-----&gt; MsLink  &lt;----&gt; Announcement Endpoint
 *
 * @author amit bhayani
 *
 */
public class MyMSCTest implements MsSessionListener, MsConnectionListener, MsLinkListener {

    private MsSession session;
    private MsProvider msProvider;

    public void startMedia() {

        // Creating the provider
        MsProvider provider = new MsProviderImpl();

        // Registering the Listeners
        provider.addSessionListener(this);
        provider.addConnectionListener(this);
        provider.addLinkListener(this);

        // Creating the Session
        session = provider.createSession();

        // Creating the connection passing the Endpoint Name. Here we are
        // creating Packet Relay Endpoint which has only two connections. One is
        // connected to UA and other we can connect to Announcement Endpoint
        MsConnection connection = session.createNetworkConnection("media/trunk/PacketRelay/$");

        // Get the Remote SDP here and pass it to connection. If creation of
        // connection is successful connectionCreated method will be called
        connection.modify("$", remoteDesc);
    }

    public void sessionActive(MsSessionEvent evt) {

    }

    public void sessionCreated(MsSessionEvent evt) {

    }

    public void sessionInvalid(MsSessionEvent evt) {

    }

    public void connectionCreated(MsConnectionEvent event) {

        // Since the Endpoint name passed was having '$' MS would have picked
        // the endpoint that is free and hence we need the actual name here
        String userEndpoint = event.getConnection().getEndpoint();

        MsLink link = session.createLink(MsLinkMode.FULL_DUPLEX);
        link.join(userEndpoint, "media/trunk/Announcement/$");

    }

    public void connectionDeleted(MsConnectionEvent event) {

    }

    public void connectionInitialized(MsConnectionEvent event) {
        // TODO Auto-generated method stub

    }

    public void connectionModifed(MsConnectionEvent event) {
        // TODO Auto-generated method stub

    }

    public void txFailed(MsConnectionEvent event) {
        // TODO Auto-generated method stub

    }

    public void linkCreated(MsLinkEvent evt) {

    }

    public void linkDropped(MsLinkEvent evt) {
        // TODO Auto-generated method stub

    }

    public void linkFailed(MsLinkEvent evt) {
        // TODO Auto-generated method stub

    }

    public void linkJoined(MsLinkEvent evt) {
        // Get the MsLink when link between Packet Relay Endpoint and
        // Announcement Endpoint is created
        MsLink link = evt.getSource();

        // Get the Announcement Endpoint Name as we used '$'
        String announcementEndpoint = link.getEndpoints()[1];

        // let us create MsSignalGenerator for Announcement Endpoint to play
        // Announcement
        MsSignalGenerator generator = msProvider.getSignalGenerator(announcementEndpoint);

        // This is hosted audio file, it can be a local file on your machine
        // For example for windows file://c:/mobicents/loopinfo.wav" for linux
        // file://user/home/loopinfo.wav"
        String url = "http://localhost:8080/msdemo/audio/loopinfo.wav";

        // Pass the URL of audio file to be played
        generator.apply(EventID.PLAY, new String[] { url });

    }
}</pre>
            </div>
            <p class="title">
               <b>Example 8.3. Example Code</b>
            </p>
         </div>
         <br class="example-break"/>
      </div>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="section-MSC_API_Objects_Finite_State_Machines.html">
               <strong>Prev</strong>8.5.4. MSC API Objects: Finite State Machines</a>
         </li>
         <li class="up">
            <a accesskey="u" href="#">
               <strong>Top of page</strong>
            </a>
         </li>
         <li class="home">
            <a accesskey="h" href="index.html">
               <strong>Front page</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="section-MMS_Event_Packages.html">
               <strong>Next</strong>8.6. MMS Event Packages</a>
         </li>
      </ul>
   </body>
</html>