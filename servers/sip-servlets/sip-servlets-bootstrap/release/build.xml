<?xml version="1.0"?>
<project name="MobicentsSipServlets" default="release" basedir=".">
	<property environment="sys"/>
	<property name="this.path" value="${ant.file.MobicentsSipServlets}/../"></property>
	<property name="base.path" value="${basedir}"></property>
	<property file="build.properties" />

	<condition property="mvn.executable" value="${sys.M2_HOME}\bin\mvn.bat" else="mvn">
	    <os family="windows"/>
	</condition>
	
	<target name="release">
		<antcall target="extract"/>
		
		<copy file="TOMCAT-SIP-SERVLETS-README.txt" todir="${base.path}/apache-tomcat-${tomcat.version}"/>
		<copy file="JBOSS-SIP-SERVLETS-README.txt" todir="${base.path}/jboss-${jboss.version}"/>
		
		<mkdir dir="${base.path}/apache-tomcat-${tomcat.version}/conf/dars"/>
		<copy file="${base.path}/../src/site/resources/click2call-dar.properties" 
			tofile="${base.path}/apache-tomcat-${tomcat.version}/conf/dars/mobicents-dar.properties"/>
			
		<mkdir dir="${base.path}/jboss-${jboss.version}/server/default/conf/dars"/>
		<copy file="${base.path}/../src/site/resources/click2call-dar.properties" 
			tofile="${base.path}/jboss-${jboss.version}/server/default/conf/dars/mobicents-dar.properties"/>
		
		<mkdir dir="${base.path}/jboss-${jboss.version}/server/all/conf/dars"/>
		<copy file="${base.path}/../src/site/resources/click2call-dar.properties" 
			tofile="${base.path}/jboss-${jboss.version}/server/all/conf/dars/mobicents-dar.properties"/>
			
		<copy file="${base.path}/server-tomcat-6.xml" tofile="${base.path}/apache-tomcat-${tomcat.version}/conf/server.xml"/>
		
		<copy file="${base.path}/server-jboss.xml" tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/jboss-web.deployer/server.xml"/>
		<copy file="${base.path}/context-jboss.xml" tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/jboss-web.deployer/context.xml"/>
		<copy file="${base.path}/jboss-service.xml" tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/jboss-web.deployer/META-INF/jboss-service.xml"/>
		<copy file="${base.path}/webserver-xmbean.xml" tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/jboss-web.deployer/META-INF/webserver-xmbean.xml"/>						

		<copy file="${base.path}/../../sip-servlets-impl/docs/failover-server-jboss.xml" tofile="${base.path}/jboss-${jboss.version}/server/all/deploy/jboss-web.deployer/server.xml"/>
		<!-- <copy file="${base.path}/server-jboss.xml" tofile="${base.path}/jboss-${jboss.version}/server/all/deploy/jboss-web.deployer/server.xml"/> -->
		<copy file="${base.path}/context-jboss.xml" tofile="${base.path}/jboss-${jboss.version}/server/all/deploy/jboss-web.deployer/context.xml"/>
		<copy file="${base.path}/../../sip-servlets-impl/docs/jboss-service-all.xml" tofile="${base.path}/jboss-${jboss.version}/server/all/deploy/jboss-web.deployer/META-INF/jboss-service.xml"/>
		<copy file="${base.path}/webserver-xmbean.xml" tofile="${base.path}/jboss-${jboss.version}/server/all/deploy/jboss-web.deployer/META-INF/webserver-xmbean.xml"/>
			
		<!-- The Sip Load Balancer -->
		<mkdir dir="${base.path}/jboss-${jboss.version}/sip-balancer"/>
		<get src="http://snapshots.jboss.org/maven2/org/mobicents/tools/sip-balancer/1.0-SNAPSHOT/sip-balancer-1.0-20080729.163357-20-jar-with-dependencies.jar" 
		    dest="${base.path}/jboss-${jboss.version}/sip-balancer/sip-balancer-1.0-20080729.163357-20-jar-with-dependencies.jar" 
		    verbose="true"
		    usetimestamp="true"/>
		<get src="http://mobicents.googlecode.com/svn/trunk/tools/sip-balancer/src/test/resources/lb-configuration.properties" 
		    dest="${base.path}/jboss-${jboss.version}/sip-balancer/lb-configuration.properties" 
		    verbose="true"
		    usetimestamp="true"/>
		
		<exec executable="${mvn.executable}" dir="${base.path}/..">
			<arg line="clean install -DCATALINA_HOME=${base.path}/apache-tomcat-${tomcat.version}"/>
		</exec>
			 
		<exec executable="${mvn.executable}" dir="${base.path}/..">
			<arg line="clean install -P jboss-distro -DJBOSS_HOME=${base.path}/jboss-${jboss.version}"/>
		</exec>

		<exec executable="${mvn.executable}" dir="${base.path}/..">
			<arg line="clean install -P jboss-distro -DJBOSS_HOME=${base.path}/jboss-${jboss.version} -Dnode=all"/>
		</exec>
				
		<exec executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/click-to-call">
			<arg line="clean install"/>
		</exec>
		
		<exec executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/simple-sip-servlet-distributable">
			<arg line="clean install"/>
		</exec>
		
		<delete failonerror="false" verbose="true" dir="${base.path}/jboss-${jboss.version}/server/minimal"/>
		
		<copy file="${base.path}/../../sip-servlets-examples/click-to-call/target/click-to-call-servlet-1.0.war" tofile="${base.path}/apache-tomcat-${tomcat.version}/webapps/click2call.war" />
		<copy file="${base.path}/../../sip-servlets-examples/click-to-call/target/click-to-call-servlet-1.0.war" tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/click2call.war" />
		<copy file="${base.path}/../../sip-servlets-examples/simple-sip-servlet-distributable/target/simple-sip-servlet-distributable-1.0.war" tofile="${base.path}/jboss-${jboss.version}/server/all/deploy/simple-distributable.war" />
		<copy overwrite="true" file="${base.path}/../../sip-servlets-examples/simple-sip-servlet-distributable/distributable-simple-dar.properties" tofile="${base.path}/jboss-${jboss.version}/server/all/conf/dars/mobicents-dar.properties" />
				
		<ant target="deploy-mgmnt">
            <property name="system.JBOSS_HOME" value="${base.path}/jboss-${jboss.version}"/>
            <property name="system.GWT_HOME" value="${base.path}/gwt-linux-${gwt.version}"/>
        </ant>
		<copy todir="${base.path}/jboss-${jboss.version}/server/all/deploy/">
		    <fileset dir="${base.path}/jboss-${jboss.version}/server/default/deploy/" includes="*media*.sar/**"/>
		</copy>

		<ant target="deploy-media"/>
		<copy todir="${base.path}/jboss-${jboss.version}/server/all/deploy/">
		    <fileset dir="${base.path}/jboss-${jboss.version}/server/default/deploy/" includes="sip-servlets-manage*"/>
		</copy>

        <delete dir="." includes="mss-${mss.release.version}-*.zip"/>
        <tstamp>
            <format property="time.stamp" pattern="yyMMddHHmm" />
        </tstamp>
		<ant target="make-final-zip-jboss"></ant>
		<ant target="make-final-zip-tomcat"></ant>
        <ant target="make-src-zip"></ant>
		
        <ant target="clean"></ant>
	</target>
	
	<target name="deploy-mgmnt">
		<ant dir="${base.path}/../../sip-servlets-management/" antfile="build.xml" target="war" />
		<copy file="${base.path}/../../sip-servlets-management/build/tmp/sip-servlets-management.war"
			tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/sip-servlets-management.war"/>
		<copy file="${base.path}/../../sip-servlets-management/build/tmp/sip-servlets-management.war"
			tofile="${base.path}/jboss-${jboss.version}/server/default/deploy/sip-servlets-management.war"/>
		<copy file="${base.path}/../../sip-servlets-management/build/tmp/sip-servlets-management.war"
			tofile="${base.path}/apache-tomcat-${tomcat.version}/webapps/sip-servlets-management.war"/>
	</target>
	
	<available file="${ant.file.mobicents.release}/../mobicents-media-server-core" property="mobicents.media.server.checked.out"/>
	<target name="get-mobicents-media-server" unless="mobicents.media.server.checked.out">
        <echo>Checking out Mobicents Media Server</echo>
		<delete dir="mms"/>
		<mkdir dir="mms"/>
		<exec executable="${mvn.executable}" dir="${ant.file.mobicents.release}/../">
            <arg line="-f external-components-checkout.xml install -Dexternal.modules.basedir=mms/mobicents-media-server-core"/>
        </exec>
	</target>
	
	<target name="build-mobicents-media-server">
        <echo>Building Mobicents Media Server</echo>
        <exec executable="${mvn.executable}" dir="${ant.file.mobicents.release}/../mms/mobicents-media-server-core">
            <arg line="install -Djboss.home=${base.path}/jboss-${jboss.version}" />
        </exec>
	</target>
		
	<target name="deploy-media" depends="get-mobicents-media-server,build-mobicents-media-server" />
	
	<target name="make-final-zip-jboss">
		<fixcrlf srcdir="${base.path}/jboss-${jboss.version}/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${base.path}/mss-${mss.release.version}-jboss-${jboss.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${base.path}/jboss-${jboss.version}/bin" filemode="755" prefix="bin">
		        <include name="*.sh" />
			</zipfileset>
         	<zipfileset dir="${base.path}/jboss-${jboss.version}/bin" prefix="bin">
            	<exclude name="*.sh" />
         	</zipfileset>
         	<zipfileset dir="${base.path}/jboss-${jboss.version}" prefix="" 
                excludes="**/bin/** **/server/*/data/** **/server/*/log/** **/server/*/tmp/** **/server/*/work/** **/server/tmp/**"/>
		</zip>
	</target>

	<target name="make-final-zip-tomcat">
		<fixcrlf srcdir="${base.path}/apache-tomcat-${tomcat.version}/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${base.path}/mss-${mss.release.version}-apache-tomcat-${tomcat.version}-${time.stamp}.zip" filesonly="false">
			<zipfileset dir="${base.path}/apache-tomcat-${tomcat.version}/bin" filemode="755" prefix="bin">
		        <include name="*.sh" />
			</zipfileset>
         	<zipfileset dir="${base.path}/apache-tomcat-${tomcat.version}/bin" prefix="bin">
            	<exclude name="*.sh" />
         	</zipfileset>
         	<zipfileset dir="${base.path}/apache-tomcat-${tomcat.version}" prefix="">
            	<exclude name="bin/**"/>
         	</zipfileset>
		</zip>
	</target>
	
	<target name="release-mc-distro" depends="extract-gwt">
		<echo>Base path: ${this.path}</echo>
		<mkdir dir="${jboss.dir}/server/default/conf/dars"/>
		<copy verbose="true" failonerror="true" file="${this.path}/../src/site/resources/click2call-dar.properties" 
			todir="${jboss.dir}/server/default/conf/dars"/>
			
		<copy verbose="true" overwrite="true" failonerror="true" file="${this.path}/server-jboss.xml" tofile="${jboss.dir}/server/default/deploy/jboss-web.deployer/server.xml"/>
		<copy verbose="true" overwrite="true" failonerror="true" file="${this.path}/context-jboss.xml" tofile="${jboss.dir}/server/default/deploy/jboss-web.deployer/context.xml"/>
		<copy verbose="true" overwrite="true" failonerror="true" file="${this.path}/jboss-service.xml" todir="${jboss.dir}/server/default/deploy/jboss-web.deployer/META-INF"/>
		<copy verbose="true" overwrite="true" failonerror="true" file="${this.path}/webserver-xmbean.xml" todir="${jboss.dir}/server/default/deploy/jboss-web.deployer/META-INF"/>						
		<echo>Done copying.</echo>
		<exec executable="${mvn.executable}" dir="${this.path}/..">
			<arg line="clean install -Pjboss-distro -DJBOSS_HOME=${basedir}/../../../../release/output/jboss-${jboss.version}/"/>
		</exec>
		
		<exec executable="${mvn.executable}" dir="${this.path}/../../sip-servlets-examples/click-to-call">
			<arg line="clean install"/>
		</exec>
		
		<copy file="${this.path}/../../sip-servlets-examples/click-to-call/target/click-to-call-servlet-1.0.war" 
			tofile="${jboss.dir}/server/default/deploy/click2call.war" />
		
		<ant dir="${this.path}/../../sip-servlets-management/" antfile="build.xml" target="war">
            <property name="system.JBOSS_HOME" value="${basedir}/../../../../release/output/jboss-${jboss.version}/"/>
            <property name="system.GWT_HOME" value="${base.path}/gwt-linux-${gwt.version}"/>
		</ant>
		
		<copy file="${this.path}/../../sip-servlets-management/build/tmp/sip-servlets-management.war"
			tofile="${jboss.dir}/server/default/deploy/sip-servlets-management.war"/>
		
	</target>
	
	<target name="set-src-excludes">
        <defaultexcludes add="**/target/**"/>
        <defaultexcludes add="**/docs/**"/>
        <defaultexcludes add="**/legacy/**"/>
        <defaultexcludes add="**/release/**"/>
        <defaultexcludes add="**/logs/**"/>
        <defaultexcludes add="**/tests/**"/>
        <defaultexcludes add="**/build/**"/>
        <defaultexcludes add="**/GWT/**"/>
        <defaultexcludes add="**/${*}/**"/>
        <defaultexcludes add="**/*JBOSS_HOME*/**"/>
        <defaultexcludes add="**/*CATALINA_HOME*/**"/>
        <defaultexcludes add="**/.gwt-cache/**"/>
        <defaultexcludes add="**/.settings/**"/>
        <defaultexcludes add="**/.project"/>
        <defaultexcludes add="**/.classpath"/>
        <defaultexcludes add="**/*.class" echo="true"/>
    </target>
    
    <target name="make-src-zip" depends="set-src-excludes">
        <property name="zip.filename" value="mss-${mss.release.version}-${time.stamp}-src.zip" />
        
        <copy todir="${base.path}/src/mobicents/servers/sip-servlets" includeEmptyDirs="false">
            <fileset dir="${ant.file.mobicents.release}/../../.." 
            	     includes="**/sip-servlets-application-router/** **/sip-servlets-bootstrap/** **/sip-servlets-examples/click-to-call/** **/sip-servlets-impl/** **/sip-servlets-management/** **/sip-servlets-spec/**"
                     excludes="**/mobicents-skin/** **/sip-servlets-bootstrap/src/site/** **/sip-servlets-impl/null/** **/www/**"/>
        </copy>
        
        <zip destfile="${ant.file.mobicents.release}/../${zip.filename}" basedir="${base.path}/src"/>
        <delete dir="${base.path}/src"/>
        
        <defaultexcludes default="true"/>
    </target>

	<target name="clean">
		<delete dir="${base.path}/jboss-${jboss.version}" />
        <delete dir="${base.path}/apache-tomcat-${tomcat.version}" />
		<delete dir="${base.path}/gwt-linux-${gwt.version}" />
	</target>

	<!-- Download and dependency building -->
	<target name="proxyflags">
		<!-- check proxy parameters. -->
		<condition property="useproxy">
			<equals arg1="${proxy.use}" arg2="on" />
		</condition>
	</target>

	<target name="setproxy" depends="proxyflags" if="useproxy">
		<taskdef name="setproxy" classname="org.apache.tools.ant.taskdefs.optional.net.SetProxy" />
		<setproxy proxyhost="${proxy.host}" proxyport="${proxy.port}" proxyuser="${proxy.user}" proxypassword="${proxy.password}" />
		<echo message="Using ${proxy.host}:${proxy.port} to download ${sourcefile}" />
	</target>

	<target name="downloadgz" depends="setproxy">
		<!-- Download and extract the package -->
		<get src="${sourcefile}" dest="${base.path}/file.tar.gz" />
		<gunzip src="${base.path}/file.tar.gz" dest="${base.path}/file.tar" />
		<untar src="${base.path}/file.tar" dest="${base.path}" />
		<delete file="${base.path}/file.tar" />
		<delete file="${base.path}/file.tar.gz" />
	</target>

	<target name="downloadzip" depends="setproxy">
		<!-- Download and extract the package -->
		<get src="${sourcefile}" dest="${base.path}/file.zip" />
		<mkdir dir="${destdir}" />
		<unzip src="${base.path}/file.zip" dest="${destdir}" />
		<delete file="${base.path}/file.zip" />
	</target>

	<target name="downloadfile" depends="setproxy">
		<!-- Download extract the file -->
		<mkdir dir="${destdir}" />
		<get src="${sourcefile}" dest="${destfile}" />
	</target>		

	<target name="extractzip" depends="setproxy">			
		<mkdir dir="${destdir}" />
		<unzip src="${sourcefile}" dest="${destdir}" />		
	</target>
	
	<target name="extract" description="Builds and download dependent components">		
		<antcall target="extractzip">
			<param name="sourcefile" value="${tomcat-path}" />			
			<param name="destdir" value="${base.path}" />
		</antcall>				
		<antcall target="extractzip">
			<param name="sourcefile" value="${jboss-path}" />			
			<param name="destdir" value="${base.path}" />
		</antcall>
		<antcall target="extract-gwt" />
	</target>
	
   <target name="extract-gwt" depends="setproxy" >
       <mkdir dir="${base.path}" />
       <untar compression="gzip" src="${gwt-path}" dest="${base.path}" />
    </target>
	
</project>
