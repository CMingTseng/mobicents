<?xml version="1.0"?>
<project name="mobicents.all.release" default="release" basedir=".">

	<property environment="sys"/>

	<property name="release.dir" value="${ant.file.mobicents.all.release}/../target/release"/>
	<property name="jboss.version" value="4.2.2.GA"/>
	<property name="release.version" value="1.2.0.CR2"/>
	<property name="jboss.distro.zip.path" value="jboss-${jboss.version}.zip"/>
	<property name="jboss.home" value="${release.dir}/jboss-${jboss.version}/"/>

	<condition property="mvn.executable" value="${sys.M2_HOME}\bin\mvn.bat" else="mvn">
		<os family="windows"/>
	</condition>

	<taskdef onerror="fail" resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${ant.file.mobicents.release}/../ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<target name="release" depends="get-jboss,unzip-jboss,get-servers,build-src-zip,release-jain-slee,release-media,release-sip-presence,release-sip-servlets-all-and-default">
		<copy file="${ant.file.mobicents.all.release}/../readme.txt" todir="${release.dir}" overwrite="true"/>
		<antcall target="zip-release"/>
		<antcall target="clean"/>
	</target>

	<!-- get, unzip and clean jboss -->

	<available file="${ant.file.mobicents.all.release}/../${jboss.distro.zip.path}" property="got.jboss" />
	<target name="get-jboss" unless="got.jboss">
		<echo>Downloading JBoss AS</echo>
		<get dest="${ant.file.mobicents.all.release}/../${jboss.distro.zip.path}" src="http://downloads.sourceforge.net/jboss/jboss-${jboss.version}.zip" />
	</target>

	<target name="unzip-jboss">
		<delete dir="${jboss.home}" failonerror="true" />
		<unzip src="${jboss.distro.zip.path}" dest="${release.dir}" />
		<delete dir="${jboss.home}/server/minimal" />
	</target>

	<!-- get servers -->

	<condition property="servers.checkedout">
		<and>
			<available file="${ant.file.mobicents.all.release}/../target/servers/jain-slee/.svn/entries" />
			<available file="${ant.file.mobicents.all.release}/../target/servers/media/core/.svn/entries" />
			<available file="${ant.file.mobicents.all.release}/../target/servers/media/controllers/.svn/entries" />
			<available file="${ant.file.mobicents.all.release}/../target/servers/media/examples/.svn/entries" />
			<available file="${ant.file.mobicents.all.release}/../target/servers/media/release/.svn/entries" />
			<available file="${ant.file.mobicents.all.release}/../target/servers/sip-presence/.svn/entries" />
			<available file="${ant.file.mobicents.all.release}/../target/servers/sip-servlets/.svn/entries" />
		</and>
	</condition>
	<target name="get-servers" depends="checkout-servers,update-servers" />

	<target name="checkout-servers" unless="servers.checkedout">
		<echo>Checking out servers</echo>
		<exec executable="${mvn.executable}" dir="${ant.file.mobicents.all.release}/../">
			<arg line="validate -P checkout" />
		</exec>
	</target>

	<target name="update-servers">
		<echo>Updating servers</echo>
		<exec executable="${mvn.executable}" dir="${ant.file.mobicents.all.release}/../">
			<arg line="validate -P update" />
		</exec>
	</target>

	<!-- release servers -->

	<target name="release-jain-slee">
		<ant antfile="${ant.file.mobicents.all.release}/../target/servers/jain-slee/release/build.xml" target="release-mobicents-all">
			<property name="release.dir" value="${release.dir}" />
			<property name="jboss.config" value="all" />
		</ant>
		<ant antfile="${ant.file.mobicents.all.release}/../target/servers/jain-slee/release/build.xml" target="release-mobicents-all">
			<property name="release.dir" value="${release.dir}" />
			<property name="jboss.config" value="default" />
		</ant>
	</target>

	<target name="release-media">
		<!-- tmp stuff, some scripts in the mms tagged must be replaced to make the release work -->
		<!--copy file="${ant.file.mobicents.all.release}/../tmp/media/release/build.xml"
			tofile="${ant.file.mobicents.all.release}/../target/servers/media/release/build.xml"
			overwrite="true"/>
		<copy file="${ant.file.mobicents.all.release}/../tmp/media/controllers/mgcp/mgcp-ra/pom.xml"
			tofile="${ant.file.mobicents.all.release}/../target/servers/media/controllers/mgcp/mgcp-ra/pom.xml"
			overwrite="true"/>
		<copy file="${ant.file.mobicents.all.release}/../tmp/media/controllers/msc/pom.xml"
			tofile="${ant.file.mobicents.all.release}/../target/servers/media/controllers/msc/pom.xml"
			overwrite="true"/>
		<copy file="${ant.file.mobicents.all.release}/../tmp/media/examples/call-controller2/pom.xml"
			tofile="${ant.file.mobicents.all.release}/../target/servers/media/examples/call-controller2/pom.xml"
			overwrite="true"/>
		<copy file="${ant.file.mobicents.all.release}/../tmp/media/examples/converged-demo/pom.xml"
			tofile="${ant.file.mobicents.all.release}/../target/servers/media/examples/converged-demo/pom.xml"
			overwrite="true"/>
		<copy file="${ant.file.mobicents.all.release}/../tmp/media/examples/mms-demo/pom.xml"
			tofile="${ant.file.mobicents.all.release}/../target/servers/media/examples/mms-demo/pom.xml"
			overwrite="true"/-->
		<property name="jboss.home.converted" location="${jboss.home}"/>
		<ant antfile="${ant.file.mobicents.all.release}/../target/servers/media/release/build.xml" target="release-mobicents-all">
			<property name="release.dir" value="${release.dir}"/>
			<property name="jboss.home" value="${jboss.home.converted}"/>
			<property name="jboss.config" value="all" />
		</ant>
		<ant antfile="${ant.file.mobicents.all.release}/../target/servers/media/release/build.xml" target="release-mobicents-all">
			<property name="release.dir" value="${release.dir}" />
			<property name="jboss.home" value="${jboss.home.converted}" />
			<property name="jboss.config" value="default" />
		</ant>
	</target>

	<target name="release-sip-presence">
		<ant antfile="${ant.file.mobicents.all.release}/../target/servers/sip-presence/release/build.xml" target="release-mobicents-all">
			<property name="release.dir" value="${release.dir}" />
			<property name="release.build.jboss.home" value="${home}../jboss-${jboss.version}" />
			<property name="jboss.config" value="all" />
		</ant>
		<ant antfile="${ant.file.mobicents.all.release}/../target/servers/sip-presence/release/build.xml" target="release-mobicents-all">
			<property name="release.dir" value="${release.dir}"/>
			<property name="release.build.jboss.home" value="${home}../jboss-${jboss.version}"/>
			<property name="jboss.config" value="default" />
		</ant>
	</target>

	<target name="release-sip-servlets">

		<!--ant antfile="${ant.file.mobicents.all.release}/../target/servers/sip-servlets/release/build.xml" target="release-mobicents-all" /-->
		
		<!-- this code should be moved to mss release script, to replace current target release-mc-distro -->
		
		<mkdir dir="${jboss.home}/server/${jboss.config}/conf/dars" />
		<copy verbose="true" failonerror="true" file="${mss.release.dir}/sip-servlets-bootstrap/src/site/resources/click2call-dar.properties" toFile="${jboss.home}/server/${jboss.config}/conf/dars/mobicents-dar.properties" />

		<copy verbose="true" overwrite="true" failonerror="true" file="${mss.release.dir}/sip-servlets-bootstrap/release/server-jboss.xml" tofile="${jboss.home}/server/${jboss.config}/deploy/jboss-web.deployer/server.xml" />
		<copy verbose="true" overwrite="true" failonerror="true" file="${mss.release.dir}/sip-servlets-bootstrap/release/context-jboss.xml" tofile="${jboss.home}/server/${jboss.config}/deploy/jboss-web.deployer/context.xml" />
		<copy verbose="true" overwrite="true" failonerror="true" file="${mss.release.dir}/sip-servlets-bootstrap/release/jboss-service.xml" todir="${jboss.home}/server/${jboss.config}/deploy/jboss-web.deployer/META-INF" />
		<copy verbose="true" overwrite="true" failonerror="true" file="${mss.release.dir}/sip-servlets-bootstrap/release/webserver-xmbean.xml" todir="${jboss.home}/server/${jboss.config}/deploy/jboss-web.deployer/META-INF" />
		<echo>Done copying.</echo>
		<property name="jboss.home.converted" location="${jboss.home}"/>
		<exec executable="${mvn.executable}" dir="${mss.release.dir}">
			<arg line="clean install -Dnode=${jboss.config} -Pjboss-distro -DJBOSS_HOME=${jboss.home.converted}" />
		</exec>

		<exec executable="${mvn.executable}" dir="${mss.release.dir}/sip-servlets-examples/click-to-call">
			<arg line="clean install" />
		</exec>

		<copy file="${mss.release.dir}/sip-servlets-examples/click-to-call/target/click-to-call-servlet-1.0.war" tofile="${jboss.home}/server/${jboss.config}/deploy/click2call.war" />

		<ant dir="${mss.release.dir}/sip-servlets-management/" antfile="build.xml" target="war">
		</ant>
		<copy file="${mss.release.dir}/sip-servlets-management/build/tmp/sip-servlets-management.war" tofile="${jboss.home}/server/${jboss.config}/deploy/sip-servlets-management.war" />

	</target>
	
	<target name="release-sip-servlets-all-and-default">
		<property name="mss.release.dir" value="${ant.file.mobicents.all.release}/../target/servers/sip-servlets"/>

		<antcall target="release-sip-servlets">
			<param name="jboss.config" value="default"/>
		</antcall>
		<antcall target="release-sip-servlets">
			<param name="jboss.config" value="all"/>
		</antcall>
		
		<property name="base.path" value="${mss.release.dir}/sip-servlets-bootstrap/release"></property>

		<!-- Build the distributable example -->
		<exec failonerror="true" executable="${mvn.executable}" dir="${base.path}/../../sip-servlets-examples/simple-sip-servlet-distributable">
			<arg line="clean install"/>
		</exec>
		<copy overwrite="true" file="${base.path}/../../sip-servlets-examples/simple-sip-servlet-distributable/distributable-simple-dar.properties" 
			tofile="${jboss.home}/server/all/conf/dars/mobicents-dar.properties" />
		<copy file="${base.path}/../../sip-servlets-examples/simple-sip-servlet-distributable/target/simple-sip-servlet-distributable-1.0.war" 
			tofile="${jboss.home}/server/all/deploy/simple-distributable.war" />
					
		<!-- Set up the all configuration with clustering enabled -->
		<copy file="${base.path}/../../sip-servlets-impl/docs/failover-server-jboss.xml" 
			tofile="${jboss.home}/server/all/deploy/jboss-web.deployer/server.xml"/>
		<copy file="${base.path}/context-jboss.xml" 
			tofile="${jboss.home}/server/all/deploy/jboss-web.deployer/context.xml"/>
		<copy file="${base.path}/../../sip-servlets-impl/docs/jboss-service-all.xml" 
			tofile="${jboss.home}/server/all/deploy/jboss-web.deployer/META-INF/jboss-service.xml"/>
		<copy file="${base.path}/webserver-xmbean.xml" 
			tofile="${jboss.home}/server/all/deploy/jboss-web.deployer/META-INF/webserver-xmbean.xml"/>
		
		<!-- The Sip Load Balancer -->
		<mkdir dir="${jboss.home}/sip-balancer"/>
		<get src="http://snapshots.jboss.org/maven2/org/mobicents/tools/sip-balancer/1.0-SNAPSHOT/sip-balancer-1.0-20080829.103906-21-jar-with-dependencies.jar" 
		    dest="${jboss.home}/sip-balancer/sip-balancer-1.0-20080829.103906-21-jar-with-dependencies.jar" 
		    verbose="true"
		    usetimestamp="true"/>
		<get src="http://mobicents.googlecode.com/svn/trunk/tools/sip-balancer/src/test/resources/lb-configuration.properties" 
		    dest="${jboss.home}/sip-balancer/lb-configuration.properties" 
		    verbose="true"
		    usetimestamp="true"/>
		
		<!-- Copy Media Server from default to all, because of broken release script in the tagges MMS -->
		<copy verbose="true" overwrite="false" todir="${jboss.home}/server/all/deploy/">
		    <fileset dir="${jboss.home}/server/default/deploy/" includes="*media*.sar/**"/>
		</copy>
		<copy verbose="true" overwrite="false" todir="${jboss.home}/server/all/lib/">
		    <fileset dir="${jboss.home}/server/default/lib/" includes="*media*.jar/**"/>
		</copy>
	</target>

	<!-- zip source -->

	<target name="build-src-zip" depends="">
		<property name="src.zip.filename" value="mobicents-all-src.zip" />
		<mkdir dir="${release.dir}/mobicents-all-src" />
		<for param="dir.name">
			<dirset dir="${ant.file.mobicents.all.release}/../target/servers"
				includes="**/src/main/java"
				 />
			<sequential>
				<echo>Packaging src for @{dir.name}</echo>
				<copy todir="${release.dir}/mobicents-all-src" includeEmptyDirs="yes">
					<fileset dir="@{dir.name}" />
				</copy>
			</sequential>
		</for>
		<zip destfile="${release.dir}/${src.zip.filename}" basedir="${release.dir}/mobicents-all-src" />
		<delete dir="${release.dir}/mobicents-all-src" />
	</target>

	<!-- zip release -->

	<target name="zip-release" depends="set-zip-filename">
		<fixcrlf srcdir="${jboss.home}/bin" includes="*.sh" eol="lf" eof="remove" />
		<zip destfile="${ant.file.mobicents.all.release}/../${zip.filename}" filesonly="false">
			<zipfileset dir="${jboss.home}/bin" filemode="755" prefix="jboss-${jboss.version}/bin">
				<include name="*.sh" />
			</zipfileset>
			<zipfileset dir="${jboss.home}/bin" prefix="jboss-${jboss.version}/bin">
				<exclude name="*.sh" />
			</zipfileset>
			<zipfileset dir="${release.dir}" prefix="" excludes="**/bin/** **/server/*/data/** **/server/*/log/** **/server/*/tmp/** **/server/*/work/** **/server/tmp/**" />
		</zip>
	</target>

	<target name="set-zip-filename" depends="set-time-stamp">
		<property name="zip-filename-prefix" value="mobicents-all-${release.version}-jboss-${jboss.version}" />
		<condition property="zip.filename" value="${zip-filename-prefix}-${time.stamp}.zip" else="${zip-filename-prefix}.zip">
			<isset property="time.stamp" />
		</condition>
	</target>

	<target name="set-time-stamp" unless="skip.timestamp">
		<tstamp>
			<format property="time.stamp" pattern="yyMMddHHmm" />
		</tstamp>
	</target>

	<!-- clean build process -->

	<target name="clean">
		<delete dir="${release.dir}" />
	</target>

</project>
