
<!--
 -->
<project basedir="." default="proxy-service-deploy" name="sipservices">


	<!-- Definitions -->
	<property environment="system" />
	<property name="jboss.home" value="${system.JBOSS_HOME}" />
	<property name="mobicents.home" value="../../../core" />

	<!-- MOBICENTS CLI -->
	<import file="${mobicents.home}/xml/ant/mobicents-ant-common-properties.xml" />

	<!-- THIS BUILD makes use of other files to create conveniant build and package -->

	<property name="du.name" value="sip-services" />
	<property name="proxy.service.id" value="JAIN SIP Proxy Service#mobicents#1.1" />
	<property name="registrar.service.id" value="SIP Registrar Service#mobicents#1.1" />
	<!-- THIS IS BAD :/, will improve, when both services are independent -->
	<property name="proxy.path.to.xml" value="org/mobicents/slee/services/sip/proxy" />
	<property name="registrar.path.to.xml" value="org/mobicents/slee/services/sip/registrar" />
	<target name="build-sbb-jars">

		<ant target="build-sbb" antfile="build_location.xml">
		</ant>
		<ant target="build-sbb" antfile="build_registrar.xml">
		</ant>
		<ant target="build-sbb" antfile="build_proxy.xml">
		</ant>
	</target>


	<target name="build-services-DU" depends="build-sbb-jars">
		<mkdir dir="classes/${du.name}-DU" />
		<mkdir dir="classes/${du.name}-DU/META-INF" />
		<copy todir="classes/${du.name}-DU" verbose="true">
			<fileset dir="./jars">
				<include name="registrar-sbb.jar" />
				<include name="sipproxy-sbb.jar" />
				<include name="location-sbb.jar" />
			</fileset>
		</copy>

		<copy tofile="classes/${du.name}-DU/META-INF/deployable-unit.xml" file="src/${proxy.path.to.xml}/sipproxy-deployable-unit.xml" verbose="true">

		</copy>

		<copy todir="classes/${du.name}-DU" file="src/${proxy.path.to.xml}/sipproxy-service.xml" verbose="true" />
		<copy todir="classes/${du.name}-DU" file="src/${registrar.path.to.xml}/registrar-service.xml" verbose="true" />

		<jar destfile="jars/${du.name}-DU.jar" basedir="classes/${du.name}-DU">
		</jar>
	</target>

	<target name="clean">
		<delete dir="jars" />
		<delete dir="classes" />
		<ant target="clean" antfile="build_registrar.xml" />
		<ant target="clean" antfile="build_proxy.xml" />
		<ant target="clean" antfile="build_location.xml" />
	</target>








	<!-- Deploys the SIP proxy to JBOSS. -->
	<target name="proxy-service-deploy" depends="build-services-DU,init-common" description="Deploys the SIP Proxy Service">
		<path id="proxyservice">
			<pathelement location="jars/${du.name}-DU.jar" />
		</path>
		<pathconvert targetos="unix" property="proxyservice" refid="proxyservice" />
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<install url="${file_url}${proxyservice}" />
		</slee-management>
		<echo>Proxy Service deployed</echo>
		<!-- Activate the proxy service -->
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">

			<activateservice serviceid="${proxy.service.id}" />
		</slee-management>
		<sleep seconds="15"/>
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<activateservice serviceid="${registrar.service.id}" />

		</slee-management>

		<echo> proxy service activated </echo>
	</target>


	<target name="proxy-service-undeploy" depends="init-common" description="unDeploys the SIP Proxy Service">
		<path id="proxyservice">
			<pathelement location="jars/${du.name}-DU.jar" />
		</path>
		<pathconvert targetos="unix" property="proxyservice" refid="proxyservice" />

		<!-- Activate the proxy service -->
		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<deactivateservice serviceid="${proxy.service.id}" />
			<deactivateservice serviceid="${registrar.service.id}" />
		</slee-management>
		<echo> proxy service deactivated </echo>

		<slee-management jnpport="${jnpPort}" host="${jnpHost}">
			<uninstall url="${file_url}${proxyservice}" />
		</slee-management>
		<echo>Proxy Service deployed</echo>
	</target>







</project>
