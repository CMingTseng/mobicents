<?xml version="1.0" encoding="UTF-8"?>
<project name="Mobicents Common Ant Targets for SLEE Services">
	
	<!--
		
		Common Ant Targets for your SLEE Services
		Author: Eduardo Martins
		Portugal Telecom Inovação (www.ptinovacao.pt)
		Contributed to Mobicents Project
		
		To use these targets your SLEE service
		there are some issues:
		
			1. You need to define, in the ant build file that will
			   import this one, the properties:			   			   
			       
			     º service.name - this service name will be used to
                   to identify service files, name jars and temp dirs;
                   
			     º service.id - the SLEE service id for deploy, for
			       example: PresenceService#pt.ptinovacao#1.0;
			     
			     º service.src.path - the relative path, from project's
			       home, to the service files;
			       
			     º service.inludes.src.path - this is path with all required files to run
			       
		    2. The SLEE service descriptors files must be named:
		       
		         º sbb jar descriptor - service.name + "-sbb-jar.xml"
		         
		         º service descriptor - service.name + "-service.xml"
		         
		         º deployable unit jar descriptor - service.name + "-deployable-unit.xml"
		         
		    3. Dir "classes" will be used to compile the service
		    
   		    4. Service "jars" will be created in "jars" dir
   		    
		    5. Service sbb jar will be named service.name + "-sbb.jar"
		       
		    6. Service deployable unit jar will be named service.name + "-DU.jar"
		    
		    7. You may use the target named add-other-jars-to-DU to add
		       other jars/classes to your deployable unit. To use this you need to
		       define a fileset with id "service.other.jars" with the jars/classes
		       to add		  
	      8. If you want to compile sources in debug mode just define property compile.as.debug with value "true" BEFORE importing this file.		    	      
		   		   
	-->
	
	<property name="compile.as.debug" value="false" />
	<property name="service.inludes.src.path" value="**/*.java"/>
	<fileset id="service.other.jars" file="." />
	
	<import file="${ant.file.Mobicents Common Ant Targets for SLEE Services}/../mobicents-ant-common-properties.xml"/>
	
	<target name="build-sbb">
	  	<mkdir dir="classes/${service.name}-sbb"/>		
		<mkdir dir="jars"/>
		<javac destdir="classes/${service.name}-sbb" srcdir="src" debug="${compile.as.debug}" includes="${service.inludes.src.path}">
		    <classpath>
		    	<path refid="service.classpath"/>
		    </classpath>	
		</javac>		    	
    	<copy todir="classes/${service.name}-sbb/${service.src.path}">
    	    <fileset dir="src/${service.src.path}">
    	     	<exclude name="**/*.java"/>
    	    	<exclude name="${service.name}-deployable-unit.xml"/>
    	    	<exclude name="${service.name}-sbb-jar.xml"/>
    	    	<exclude name="${service.name}-service.xml"/>
    	    </fileset>
    	</copy>    		    	
		<copy file="src/${service.src.path}/${service.name}-sbb-jar.xml" tofile="classes/${service.name}-sbb/META-INF/sbb-jar.xml"/>		    	
    	<jar jarfile="jars/${service.name}-sbb.jar">    		
    		<fileset dir="classes/${service.name}-sbb" />
    	</jar> 
    </target>    
	
	<target name="add-other-jars-to-DU">
	   	<copy todir="classes/${service.name}-DU/library">
	   		<fileset refid="service.other.jars" />
	   	</copy>    	
	</target>
	
    <target name="build-DU">
    	<mkdir dir="classes/${service.name}-DU"/>    	
    	<copy file="src/${service.src.path}/${service.name}-deployable-unit.xml" tofile="classes/${service.name}-DU/META-INF/deployable-unit.xml"/>    			
    	<copy todir="classes/${service.name}-DU">
    		<fileset includes="jars/${service.name}-sbb.jar" dir=""/>        	         		    			
    	    <fileset includes="src/${service.src.path}/${service.name}-service.xml" dir=""/>		
    	</copy>
    	<mkdir dir="jars"/>
    	<jar destfile="jars/${service.name}-DU.jar">
    		<fileset dir="classes/${service.name}-DU" />
    	</jar>    	
    </target>
	
	<target name="clean" depends="clean-sbb, clean-DU" />
	   
	<target name="clean-sbb">
	    <delete file="jars/${service.name}-sbb.jar"/>
	    <delete dir="classes/${service.name}-sbb"/>
	</target>
		
	 <target name="clean-DU">
        <delete file="jars/${service.name}-DU.jar"/>
        <delete dir="classes/${service.name}-DU"/>
    </target>
	
	<target name="create-deploy-url">
		<path id="service.url.to.deploy">		
			<pathelement location="jars/${service.name}-DU.jar"/>
		</path>
		<property name="service.url.to.deploy" refid="service.url.to.deploy"/>
	</target>	
	
	<target name="install-DU" depends="create-deploy-url,init-common">		
		<echo>Installing ${service.name} DU in URL ${service.url.to.deploy}</echo>
		<slee-management host="${jnpHost}" jnpport="${jnpPort}" user="${user}" password="${password}">
			<install url="${file_url}${service.url.to.deploy}"/>				
		</slee-management>
    </target>
	
	<target name="deploy-DU-management" depends="create-deploy-url,init-common">		
		<echo>Deploying ${service.name} DU in URL ${service.url.to.deploy}</echo>
		<slee-management host="${jnpHost}" jnpport="${jnpPort}" user="${user}" password="${password}">
			<install url="${file_url}${service.url.to.deploy}"/>
			<activateservice serviceid="${service.id}"/>
		</slee-management>
    </target>

	<target name="deploy-DU-persistent" depends="create-deploy-url,init-common">		
		<echo>Deploying ${service.name} DU in URL ${service.url.to.deploy}</echo>
    <copy file="${service.url.to.deploy}" todir="${jboss.deploy}" />
  </target>

	<target name="uninstall-DU" depends="create-deploy-url,init-common">		
		<echo>Uninstalling ${service.name} DU in URL ${service.url.to.deploy}</echo>
		<slee-management host="${jnpHost}" jnpport="${jnpPort}" user="${user}" password="${password}">			
			<uninstall url="${file_url}${service.url.to.deploy}"/>
		</slee-management>
	</target>
	
	<target name="undeploy-DU-management" depends="create-deploy-url,init-common">		
		<echo>Undeploying ${service.name} DU in URL ${service.url.to.deploy}</echo>
		<slee-management host="${jnpHost}" jnpport="${jnpPort}" user="${user}" password="${password}">
			<deactivateservice serviceid="${service.id}"/>
			<uninstall url="${file_url}${service.url.to.deploy}"/>
		</slee-management>
	</target>
	
	<target name="undeploy-DU-persistent" depends="create-deploy-url,init-common">		
	  <echo>Undeploying ${service.name} DU in URL ${service.url.to.deploy}</echo>
    <delete file="${jboss.deploy}/${service.name}-DU.jar" />
  </target>

  <target name="deploy-DU">
    <antcall target="deploy-DU-${deploy.method}" /> 
  </target>

  <target name="undeploy-DU">
    <antcall target="undeploy-DU-${deploy.method}" /> 
  </target>

	<target name="build-and-deploy-service" depends="build-sbb,build-DU,deploy-DU" />

</project> 